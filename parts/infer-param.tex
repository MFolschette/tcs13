\section{Parametrization inference}\label{sec:infer-K}

Given the IG inferred from a PH as presented in the previous section, one can find the discrete parameters that model the behavior of the studied PH using the method presented in the following.
It relies on an exhaustive enumeration of all predecessors of each component in order to find attractor processes and returns a possibly incomplete parametrization, given the exhaustiveness of the cooperations.
The last step consists of the enumeration of all compatible complete parametrizations given this
set of inferred parameters, the PH dynamics and some biological constraints on parameters.

\subsection{Parameters inference}

This subsection presents some results related to the inference of independent discrete parameters from a given PH.
These results are equivalent to those presented in \cite{PMR10-TCSB}, with notation adapted to be shared with the previous section.
In addition, we introduce the well-formed PH for parameter inference property (\pref{pro:wf-ph-K}),
which implies that the inferred IG does not contain any unsigned interactions, and thus can be seen as the
regular IG $(\Gamma, E)$,
and that any processes in $\levels{b}{a}$ (resp. $\ulevels{b}{a}$) share the same behavior
regarding $a$.

\begin{property}[Well-formed PH for parameter inference]\label{pro:wf-ph-K}
A PH is well-formed for parameter inference if and only if
it is well-formed for IG inference, and
the IG $(\Gamma, E)$ inferred by \pref{pps:inference-IG}
verifies the following property:
\begin{align*}
  \begin{split}
  \forall a \in \Gamma, \forall b\in \GRNreg{a}&,
          \forall (i,j\in\levels{b}{a} \vee i,j\in\ulevels{b}{a}), \\
  & \quad \forall c \in \Gamma, ( (b\neq a\wedge c=a) \vee (c\in\PHpredec{a} \wedge b\in\PHdirectpredec{c})), \\
  & \qquad
                          \PHfrappe{b_i}{c_k}{c_l}\in\PHa \Leftrightarrow
                                  \PHfrappe{b_j}{c_k}{c_l}\in\PHa
  \end{split}
\end{align*}
\end{property}

Let $K_{a,\omega}$ be the parameter we want to infer for a given component $a \in \Gamma$
and $\omega \subset \GRNreg{a}$ a set of its regulators.
This inference, as for the IG inference, relies on the search of focal processes of the component for the given configuration of its regulators.

For each sort $b \in \GRNreg{a}$, we define a context $C^b_{a,\omega}$ in \pref{eq:param_context} that contains all processes representing the influence of the resources in the configuration modeled by $\omega$.
The context of a cooperative sort $\upsilon$ that regulates $a$ is given in
\pref{eq:param_context_coop} as the set of focal processes matching the current configuration.
$C_{a,\omega}$ refers to the union of all these contexts (\pref{eq:K-ctx}).
\begin{align}
  \label{eq:param_context}
  \forall b\in\Gamma,~
  C_{a,\omega}^b & \DEF \begin{cases}
    \levels{b}{a} & \text{if $b \in \omega$,}\\
    \ulevels{b}{a} & \text{if $b \notin \omega$,}\\
    L_b            & \text{otherwise;}\\
  \end{cases}
  \\
  \label{eq:param_context_coop}
  \forall \upsilon \in \PHpredec{a}\setminus\Gamma,~
  C_{a,\omega}^\upsilon & \DEF \{
  \upsilon(\sigma) \mid \sigma \in \textstyle\prod_{c\in\PHdirectpredec{\upsilon}}C_{a,\omega}^c \}
  \\
  C_{a,\omega} & \DEF \textstyle\bigcup_{b\in\PHpredec{a}} C^b_{a,\omega}
  \label{eq:K-ctx}
\end{align}

The parameter $K_{a,\omega}$ specifies to which values $a$ eventually evolves as long as the context
$C_{a,\omega}$ holds, which is precisely the definition of the $\focals$ function
(\pref{def:focals} in \pref{ssec:focal}),
where the focals reachability property can be derived from \pref{pro:wf-ph-K} and
\pref{eq:param_context_coop}.
Hence $K_{a,\omega} = \focals(a,C^a_{a,\omega},C_{a,\omega})$ if this latter is a non-empty interval
(\pref{pps:param_K}).

\begin{proposition}[Parameter inference]
\label{pps:param_K}
Let $(\PHs, \PHl, \PHh)$ be a Process Hitting well-formed for parameter inference, and $\IG = (\Gamma, E)$ the inferred IG.
Let $A$ (resp. $B$) $\subseteq \Gamma$ be the set of regulators that activate (resp. inhibit) a sort
$a$.
If $\focals(a,C^a_{a,\omega},C_{a,\omega})=\segm{a_i}{a_j}$ is a non-empty interval, then $K_{a,\omega} = \segm{i}{j}$.
\end{proposition}

\begin{example}
\label{ex:infer-param-runningPH-1}
Applied to the PH in \pref{fig:runningPH-1}, we obtain, for instance, 
$K_{b,\emptyset} = \segm{0}{1}$ and
$K_{a,\{b,c\}} = \segm{2}{2}$,
while $K_{a,\{b\}}$ and $K_{a,\{c\}}$ can not be inferred.
\end{example}

\begin{example}
For the PH in \pref{fig:runningPH-2}, we obtain
$K_{b,\emptyset} = \segm{0}{1}$,
$K_{a,\{b,c\}} = \segm{2}{2}$,
$K_{a,\{b\}} = \segm{1}{1}$,
and $K_{a,\{c\}} = \segm{1}{1}$.
For this PH, all parameters can be inferred, and the obtained parametrization is the one of \pref{fig:runningBRN}(right).
\end{example}

Given the \pref{pps:param_K}, we see that in some cases, the inference of the targeted parameter is impossible.
This can be due to a lack of cooperation between regulators: when two regulators independently hit a component, their actions can have opposite effects, leading to either an indeterministic evolution or to oscillations.
Such an indeterminism is not possible in a BRN as in a given configuration of regulators, a component can only have an interval attractor, and eventually reaches a steady-state.
In order to avoid such inconclusive cases, one has to ensure that no such behavior is allowed by
either removing undesired actions or using cooperative sorts to prevent opposite influences between
regulators.

\subsection{Admissible parametrizations}\label{ssec:admissible-K}

When building a BRN, one has to find the parametrization that best describes the desired behavior of the studied system.
Complexity is inherent to this process as the number of possible parametrizations for a given IG is exponential w.r.t. the number of components.
However, the method of parameters inference presented in this section gives some information about necessary parameters given a certain dynamics described by a PH.
This information thus drops the number of possible parametrizations, allowing to find the desired behavior more easily.

We first delimit the validity of a parameter (\pref{pro:K-valid}) in order to ensure that any
transition in the resulting BRN is allowed by the studied PH.
This is verified by the existence of a hit making the concerned component bounce into the direction
of the value of the parameter in the matching context.
Thus, assuming \pref{pro:wf-ph-K} holds, any transition in the inferred BRN corresponds to at least
one transition in the PH, proving the correctness of our inference.
We remark that any parameter inferred by \pref{pps:param_K} satisfies this property.

\begin{property}[Parameter validity]\label{pro:K-valid}
A parameter $K_{a,\omega}$ is valid w.r.t. the PH if and only if the following equation is verified:
\begin{align*}
  \forall a_i\in C^a_{a,\omega}, a_i \notin K_{a,\omega} \Longrightarrow
    (& \exists \PHfrappe{c_k}{a_i}{a_j}\in\PHa, c_k \in C^c_{a,\omega} \\
     & \wedge a_i < K_{a,\omega} \Rightarrow j > i \wedge  a_i > K_{a,\omega} \Rightarrow j <i )
\end{align*}
\end{property}

Then, we use some additional biological constraints on Thomas' parameters given in
\cite{BernotSemBRN}, that we sum up in the following three properties:

\begin{property}[Extreme values assumption]
Let $\IG = (\Gamma, E)$ be an IG. A parametrization $K$ on $\IG$ satisfies the \emph{extreme values assumption} if and only if:
\label{pro:param_enum_extreme}
\begin{align*}
  \forall b \in \Gamma, \GRNreg{b} \neq \emptyset \Longrightarrow \exists \omega \subset \GRNreg{b}, 0 \in K_{b,\omega} \wedge \exists \omega' \subset \GRNreg{b}, l_b \in K_{b,\omega'}
\end{align*}
\end{property}

\begin{property}[Activity assumption]
\label{pro:param_enum_activity}
Let $\IG = (\Gamma, E)$ be an IG. A parametrization $K$ on $\IG$ satisfies the \emph{activity assumption} if and only if:
\begin{align*}
  \forall b \in \Gamma, \forall a \in \GRNreg{b}, \exists \omega \subset \GRNreg{b}, K_{b,\omega} \neq K_{b,\omega \cup \{ a \}}
\end{align*}
\end{property}

\begin{property}[Monotonicity assumption]
\label{pro:param_enum_monotonicity}
Let $\IG = (\Gamma, E)$ be an IG. A parametrization $K$ on $\IG$ satisfies the \emph{monotonicity assumption} if and only if:
\begin{align*}
  \forall b \in \Gamma,
  \forall A^+ \subset \{ a \in \Gamma \mid \GRNedge{a}{+}{t}{b} \in E_+ \}&,
  \forall A^- \subset \{ a \in \Gamma \mid \GRNedge{a}{-}{t}{b} \in E_- \},\\
  K_{b,\omega \cup A^-} & \leqsegm K_{b,\omega \cup A^+}
\end{align*}
\end{property}



\subsection{Answer Set Programming implementation concepts}

\rewrite{This whole subsection may be completed, or turned into a new section}

\todo{Rewrite implementation with the new semantics}

\newcommand{\ti}[1]{\texttt{\textit{#1}}}
\newcommand{\aspil}[1]{\texttt{#1}}
\newcommand{\asp}[1]{\begin{itemize} \item[] \aspil{#1} \end{itemize}}

\newcommand{\atom}{\mathbf}
\newcommand{\la}{\leftarrow}
\newcommand{\var}[1]{#1}
\newcommand{\nota}{\neg}

\newcommand{\paramlabel}{\atom{param\_label}}
\newcommand{\paramres}{\atom{param\_resource}}
\newcommand{\component}{\atom{component}}
\newcommand{\componentlevels}{\atom{component\_levels}}

Answer Set Programming (ASP) \cite{Baral03} has been chosen to address the enumeration of all admissible parametrizations.
The motivations are following:
\begin{itemize}
  \item ASP efficiently tackles the inherent complexity of the models we use, thus allowing a fast execution of the formal tools defined in this paper,
  \item it is convenient to enumerate a large set of possible answers,
  \item it allows to easily constrain the answers according to some properties.
\end{itemize}
We now synthesize some key points to better make the reader understand our ASP implementation with the enumeration example.

ASP is a logic programming paradigm based on a set of rules.
A rule takes the form of:
  $$\underbrace{{\ }\atom{H}_{\ }}_{head} \la \underbrace{\atom{A}_1, \atom{A}_2, \dots, \atom{A}_n, \nota \atom{B}_1, \nota \atom{B}_2, \dots, \nota \atom{B}_m}_{body}.$$
where the $head$ is an atom ($\atom{H}$) and the $body$ is a series of atoms ($\atom{A}_i$) and negations of atoms ($\nota \atom{B}_i$).
Such a rule states that if all atoms $\atom{A}_1, \atom{A}_2, \dots, \atom{A}_n$ are true
and all atoms $\atom{B}_1, \atom{B}_2, \dots, \atom{B}_m$ are not true (negation by failure), then $\atom{H}$ has to be true.
Solving an ASP program means finding an \emph{answer set}, which is a minimal set of true atoms that respects all the rules.
Several answer sets can be solution to the same ASP program and the solver can be directed to enumerate them all.
\todo{Distinguish atoms and predicates.}

\rewrite{Facts : component}

\rewrite{Rules + variables : component\_levels}

\rewrite{Cardinalities : énumération de param + param\_label et infered\_param}

A rule with no $body$ part is called a fact, and its $head$ atom has to belong to all answer sets.
For instance, the information describing the studied model (PH and inferred IG \& parameters) are expressed in ASP using facts.
In particular, the predicate $\component$ allows to define all components belonging to the inferred IG.
Thus, an atom $\component(a, m)$ states that $a$ is a component of the IG and $l_a = m$.
Consider \pref{ex:infer-param-runningPH-1}: the inferred IG contains 3 components, and to state the existence of each of them, the following facts are used:
\begin{align*}
  &\component(a, 2).
  &\component(c, 1). \\
  &\component(b, 1).
\end{align*}

To define the sets of possible expression levels of each component (\ie the set $\segm{0}{l_a}$ for each $a \in \Gamma$),
one can use atoms of the form $\componentlevels(a, k)$ to state that $k \in \segm{0}{l_a}$.
Variables are then useful in order to enumerate each possible $k$ for all component $a$.
A variable starts with a capital letter, and during the solving,
any rule containing variables will be duplicated in order to replace each variable by all the possible values it could represent.
\rewrite{Reformulate}
For example, the following rule, which contains three variables ($\var{A}$, $\var{K}$ and $\var{M}$), enumerates all possible expression levels of all components in the system:
\begin{align*}
  \componentlevels(A, K) \la \component(\var{A}, \var{M}), 0 \leq K \leq M.
\end{align*}
The “$\leq$” notation stand for a shortcut in ASP which has the same meaning as the mathematical operator.
Regarding \pref{ex:infer-param-runningPH-1}, the previous rule will make the following set of atoms belong to all answer sets:
\begin{align*}
  &\{&\componentlevels(b, 0)
  &&\componentlevels(b, 1) \\
  &&\componentlevels(c, 0)
  &&\componentlevels(c, 1) \\
  &&\componentlevels(a, 0)
  &&\componentlevels(a, 1) \\
  &&\componentlevels(a, 2) &&&&\}
\end{align*}

Cardinality rules are convenient to enumerate all possible parametrizations by creating multiple answer sets.
The head of a cardinality rule specifies a set of atoms $H$ and two integers $min$ and $max$, and is denoted:
\begin{align*}
  min\ \{\ H\ \}\ max \la \atom{A}_1, \atom{A}_2, \dots, \atom{A}_n, \nota \atom{B}_1, \nota \atom{B}_2, \dots, \nota \atom{B}_m.
\end{align*}
Given such a rule, every answer $S$ sets have to verify:
\begin{align*}
  min \leq |S \cap H| \leq max
\end{align*}
In other words, all answer sets contain a subset of $H$ whose cardinality goes from $min$ to $max$.
The set of atoms $H = \{ \atom{H}_1, \atom{H}_2, \dots, \atom{H}_p \}$ is often defined as: $H = \atom{P} : \atom{Q}$,
which is a shorthand for “all atoms of the form $\atom{P}$ for which $\atom{Q}$ is true”.
\rewrite{Reformulate}

Given a set of atoms, it creates as many answer sets as there are possible 
constrains gives any number of possible answers for some atoms between a lower and upper bounds.
For example,
\begin{align*}
  & 1\ \{ \atom{param}(\var{X}, \var{P}, \var{I}) : \atom{component\_levels}(\var{X}, \var{I}) \} \la \\
  & \qquad\qquad\qquad \paramlabel(\var{X}, \var{P}), \nota \atom{infered\_param}(\var{X}, \var{P}).
\end{align*}



---------------

In particular, the existence of a parameter (whether its value has been inferred or not) is stated by the atom $\paramlabel$.
For functional purposes, we assign a unique label to every possible set of resources $\omega$ of a given component,
and in the following we note $K^p_{a,\omega}$ the parameter of component $a$ whose set of resources $\omega$ is assigned to the label $p$.
In other words, $\paramlabel(a, p)$ states that a parameter $K^p_{a,\omega}$ exists.
Consider \pref{ex:infer-param-runningPH-1}: the inferred IG contains 7 parameters, and to state the existence of each of them, the following facts are used:
\begin{align*}
  &\paramlabel(a,1).
  &\paramlabel(b,1).\\
  &\paramlabel(a,2).
  &\paramlabel(b,2).\\
  &\paramlabel(a,3).\\
  &\paramlabel(a,4).
  &\paramlabel(c,1).
\end{align*}

A set (such as sets of resources $\omega$) can be defined in ASP with a series of atoms. \rewrite{Find a more precise sentence.}
For example, for a given parameter $K^p_{a,\omega}$, expressing $x \in \omega$ is done by the atom: $\paramres(a, p, x)$.
Then, the sets of resources of \pref{ex:infer-param-runningPH-1} is defined by:
$$\begin{array}{>{\hspace{.8em}}l|>{\phantom{\raisebox{.6em}{xx}}}l}
  \hspace{-.8em}\text{Parameter} & \text{Corresponding ASP fact} \\
\hline
  K^0_{a,\emptyset} & \\
  K^1_{a,\{b\}} & \paramres(a,1,b). \\
  K^2_{a,\{c\}} & \paramres(a,2,c). \\
  K^3_{a,\{b,c\}} & \paramres(a,3,b). \quad \paramres(a,3,c). \phantom{\raisebox{-.8em}{xx}} \\ \hline
  K^0_{b,\emptyset} & \\
  K^1_{b,\{a\}} & \paramres(b,1,a). \phantom{\raisebox{-1em}{xx}} \\ \hline
  K^0_{c,\emptyset} &
\end{array}$$
The absence of an atom $\paramres(a,1,c)$, for example, states that $c$ is not a resource for the parameter $K^1_{a,\{b\}}$ (indeed, $c \notin \{b\}$).



\todo{Continue refactoring.}
\rewrite{Explain variables}

Rules allow more detailed declarations than facts as they have a body (right-hand part below) containing constraints and allowing to use variables, while facts only have a head (left-hand part).
For instance, in order to define the set of expression levels of a component, we declare:
$$\atom{component\_levels}(\var{X}, 0..\var{M}) \la \atom{component}(\var{X}, \var{M}).$$
where the atom $\atom{component}(X, M)$ stands for the existence of a component $X$ with a maximum level $M$.
Considering this declaration, any possible answer for the atom $\atom{component\_levels}$ will be found by binding all possible values of its two terms with all existing $\atom{component}$ facts:
the existence of an answer $\atom{component\_levels}(a, k)$ will depend on the existence of a term $a$, which is bound with $\var{X}$, and an integer $k$, constrained by: $0 \leq k \leq \var{M}$.

Cardinalities are convenient to enumerate all possible parametrizations by creating multiple answer sets.
A cardinality (denoted hereafter with curly brackets) gives any number of possible answers for some atoms between a lower and upper bounds.
For example,
\begin{align*}
  & 1\ \{ \atom{param}(\var{X}, \var{P}, \var{I}) : \atom{component\_levels}(\var{X}, \var{I}) \} \la \\
  & \qquad\qquad \paramlabel(\var{X}, \var{P}), \nota \atom{infered\_param}(\var{X}, \var{P}).
\end{align*}
where $\atom{param}(\var{X}, \var{P}, \var{I})$ stands for: $\var{I} \in K^\var{P}_{\var{X},\omega}$,
means that any parameter of component $\var{X}$ and label $\var{P}$ must contain at least one level value ($\var{I}$) in the possible expression levels of $\var{X}$.
Indeed, the lower bound is $1$, forcing at least one element in the parameter, but no upper bound is specified, allowing up to any number of answers.
The body (right-hand side) of the rule also checks for the existence of a parameter of $\var{X}$ with label $\var{P}$,
and constrains that the parametrization inference was not conclusive for the considered parameter (“$\nota$” stands for negation by failure: $\nota \atom{L}$ becomes true if $\atom{L}$ is not true).
Such a constraint gives multiple results as any set of $\atom{param}$ atoms satisfying the cardinality will lead to a new global set of answers.
In this way, we enumerate all possible parametrizations which respects the results of parameters inference,
but completely disregarding the notion of admissible parametrizations given in \pref{ssec:admissible-K}.

We rely on integrity constraints to filter only admissible parametrizations.
An integrity constraint is a rule with no head, that makes an answer set unsatisfiable if its body turns out to be true.
Hence, if we suppose that:
\begin{itemize}
  \item the $\atom{less\_active}(a, p, q)$ atom means that $K^p_{a,\omega}$ stands for a configuration with less activating regulators than $K^q_{a,\omega'}$, % (\ie $A \subset A'$),
  \item the $\atom{param\_inf}(a, p, q)$ atom means: $K^p_{a,\omega} \leqsegm K^q_{a,\omega'}$,
\end{itemize}
then the monotonicity assumption (\pref{pro:param_enum_monotonicity}) is formulated as the following integrity constraint:
$$\la \atom{less\_active}(\var{X}, \var{P}, \var{Q}), \nota \atom{param\_inf}(\var{X}, \var{P}, \var{Q}).$$
which removes all parametrization results where parameters $K^\var{P}_{\var{X},\omega}$ and $K^\var{Q}_{\var{X},\omega'}$ exist such that $\var{X}$ is less activated by $\omega$ than $\omega'$ %$A \subset A'$
but $K^\var{Q}_{\var{X},\omega'} \ltsegm K^\var{P}_{\var{X},\omega}$,
thus violating the monotonicity assumption.
Of course, other assumptions can be formulated in the same way.

This subsection succinctly described how we write ASP programs to represent a model and solve all steps of Thomas' modeling inference.
It finds a particularly interesting application in the enumeration of parameters: all possible parametrizations are generated in separate answer sets, and integrity constraints are formulated to remove those that do not fit the assumptions of admissible parametrizations,
thus reducing the number of interesting parametrizations to be considered in the end.
